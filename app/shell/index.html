<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript" src="/assets/js/hterm_all.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>        
    </head>
    <body style="height:800px;">
        <div id="terminal" style="position:relative; width:100%; height:100%"></div>
    </body>

    <script>
            hterm.defaultStorage = new lib.Storage.Local();
            const t = new hterm.Terminal();//opt_profileName);
            var localIP = '187.65.237.56',
                localPort = 8000,
                localURL = localIP + ':' + localPort;
            var url = 'http://'+localURL+'/shell';
            var command = '';
            jQuery.support.cors = true;
            function toScreen(str) {
                return str.replace(/[\n\r]/g, '\n\r');
            }
            function clean(str) {
                return str.replace('\r', '\n\r');
            }
            function addLineMarker(str) {
                return str.replace(/^/gm, '>>> ');
            }
            function termPrintOutput(str) {
                beautified = addLineMarker(str);
                cleaned = toScreen(beautified);
                t.io.print(cleaned);
            }
            function toServer(str) {
                return str.replace('\r', '\n');
            }
            t.onTerminalReady = function() {
                const io = t.io.push();
                t.io.print('$ ');
                io.onVTKeystroke = (str) => {
                    command += str;
                    if (str === '\r') {
                        if (command !== '\r') {
                            t.io.println('');
                            $.post(url, {'command': toServer(command)}, function(data){
                                console.log(data);
                                termPrintOutput(data.stdout.slice(0,-1));
                                t.io.println('');
                            }).then(function(){
                                t.io.print('$ ');
                            });
                        }
                        command = '';
                    } else {
                        t.io.print(str);
                    }

                };

                io.sendString = (str) => {
                    // Just like a keystroke, except str was generated by the terminal itself.
                    // For example, when the user pastes a string.
                    // Most likely you'll do the same thing as onVTKeystroke.
                };

                io.onTerminalResize = (columns, rows) => {
                    // React to size changes here.
                    // Secure Shell pokes at NaCl, which eventually results in
                    // some ioctls on the host.
                };

                // You can call io.push() to foreground a fresh io context, which can
                // be uses to give control of the terminal to something else.  When that
                // thing is complete, should call io.pop() to restore control to the
                // previous io object.
            };
            t.decorate(document.querySelector('#terminal'));
            t.installKeyboard();
            t.io.println('Print a string without a newline');
            t.io.println('Print a string and add CRLF');
            t.prefs_.set('cursor-blink', true);

        </script>
</html>
